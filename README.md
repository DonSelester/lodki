# Yacht club site
<br>
It`s my first student django project. Site created for some Yacht club, in this project I've used PostgreSQL 9.5.<br>
This site provides you with opportunities such as:
- Register and login as owner or renter;

- Yachts viewing;
![view_yachts](https://lh3.googleusercontent.com/fePgG4EqAkMDz94-zxACgHC3XSVO7hPcwZCJwGQGJ66_XsZH-O__05yAcVLfbSoRRRNUL8jO792gRkO41hYUIHI825WVfi66MPQIDC_MMlZobKnRPbst_RA2NCfFReztNoi_OWO8yY-xfo7jCBEJcvBSrZ78pkO3yMkChxNgEtP8o5uZNlGeTEV6hjQ588HhiyDpmmZPYD936rsZ-CGFoLeudGn_Eti7ZnsQoVjS7GqTPwxN-_8dE-ieOGw0gVuYK7dn-71-ciVgn5ybLO-iW_65_xAacPZepBCHK4A7u5YzzLBrRfPfP4G3CJwX7NHt_HvaI4HLLaRWqB3JGwOxQtXFhQRdRO-H0n2r4Afqq3bDcz4E9dZgsYolHtMVxk_5OdE1eeiz8MVKBtwLiJ4zX0PA7cjWGID0wpQYMikW3oYN8rzB4khgD-LcgQyhh7jPSMlonIOIWCo80k_yKZB-ZzN2XiMTotAj91uHhgjAQdCUavzuJbXaXflOITr1dwdATw66h_lJSlR6nx6tYvpqgkaL9hO3oqwu0XqS1TvnzDPYIU830bNRZhovVm6wRvCM-DzFkI5aJffpsM-GPTYZ45s8Eikwkj2L8pr3W3E=w1919-h973-no)
- Filter by criteria;
- Rent yacht, if you logged as renter;
![rent](https://lh3.googleusercontent.com/fImM4WpOhx8UcYL4bEX1-iH7CqIXa-4Nb0hxaGwuKQGnBzX0eKEM7Uw3fr8ocZZzU5tFYrauKml2nTJDrH3TzFnHHcy1No8kVlnxKAAlI32YoW52QwTuFp0Gq27d9gVEExbw9gyq8Bb5L-ZWChcgGR4dK-qju7dx8g-7KHnvCBHPSQGmlIYSrPpQqhA8f_-5JyJisdgjYmjuNlU5lf5xSdLtRuGv1EERk10FHtqo-KZY5jD4MmrTPULcoMwgjtFcjPzWsUPzq19FcKCTuMVLoiOV0R7EJft-l_YC6gDrLgL7LFeJrOiJQpVC3wEOZdSH98by0dlBzT0G1jrd9_I3j62ZH4KlAGMkotW60UA76ZZykQMjJo7bDkim6TTgxoxyWhCZMNYO8wqeQouoyy50xTAnStW-2pi_hzLl1E5LXXuMfv-butqtpzjSNwFlPpMXXP4Clf8g16Fb9G8Bl6am8g8-66SoBVj7HOjnvo6YpaOC1IG54FmkvAGBGXBBxsbZ7tCpClguwWydyDVcivFLfsaNhWDdZw6qgDZ97sXhggDX76b0IKsWseP7UwE0SDxrqn95Dg8JDcgDwWWFYKNj1zHmumIsz6-pV3f0cfY=w1919-h973-no)
- Add yacht, then hire crew for yacht, if you logged as owner;
![owner_profile](https://lh3.googleusercontent.com/lXe2eJWYnarg0T_0IDA3DSi57q9pDG4kUn-J3hdudolZ4UEpLv3rxp7JuzNmXlMeeAIavGT99bdvgWM3LncuaBxvpDllMqhPuzHF-CP4Rdixs9Afzl5H6fIfAuzHfp1gdTWHEkT4912-fZ008QPXXAGcctJt7GqRejqdg_Sq8roSqsoZxhGcr7dwXULyMnfQ1rfzxblR_VZ4PPSJFxzN4Nh9gXcClnMiQf5GT9ClMAOA-33_PZC2WfgmIRT7jFqkyMtEjHYvyY2nTB8lTXKHHqhNJY9a7wkvy40nG2ozJMR4g7vpVjXpIJvBhuDbWDZMGOGL-ov4Xk1656enWW6Xw6czuad2-9DHDtRlsKxOXCxSCibZJt72t7viDd7KUfKA9llhfYe9I7CPiZqXQ87tmo2YIyHHNG5qLy9dINDmJtaGinN-Q9viO4WlWyPh0efSVyZFmf5OdJNhXcp8EFO95iXWJ-Na0MXRUMjcigIm85ZPz9LZGdf2WA0c8Ait24tXWyO_rAoYF4Jsk1rBpx1hr-5LOsfNCjVDeREJoSflGpvId7X_03mSlmLgCdAJE7_-njay8--i4CkZH-lWNwD_qQuhZnnSTVExfV2bQyw=w1919-h972-no)
![crew](https://lh3.googleusercontent.com/1bZMSzMsHtRAqEXvigDKayz_mYrKs_UzaXJJiqfWtMITP4zAPIAFX8gO8CgBBR9WA6lteidHo7bLoaudZKzpi620xqd3ahn3MEOmnkOVX2J9QRlLOMbQPvT-oF466HpPpcBMLBdZv009p5hHAXSHChaFfDnNkZ4-Q7B8d6iC_0xbz2zlQ66w85kpi6Bv205nGXxBsh9zgBkkqE2hYzH9SsYFjF5K9lQafrQGngC1KGugs1WLhc3aFDFV-mhmhTcjI3gJbg-NHe-fruXVj4C9JUgFfL95tOR-DGthN8A5LomTYMND400Gbv-9eDmQyzaxpGAmILPJnnlwpFbbdTR_SJxGiGWO_rjQbA3BfDNhbaHrwN9hZ0rddomn-oDI4GilSzJ7thMFTP7GDSBbFKF4jVZijQYCSMqFjVNZYIv5D4btVECEHtP2ZmRlJiet3Fyqr0Sk7MdUryIKZndlM8qisD4Hd3wcHGaUY04b_STRWeh1tR8Cbvgia9aqmHzRS1-tA4IPYvUbgPc3gp74--AoZevR4dD92DcpyZtLGSfVc7YXFmViuDUUNPewVYVryU0gKVupEUCmarXy2BK9yHm_6iYHrudJZit73i8zpF0=w1919-h973-no)
- Order a yacht repair, if you logged as owner;

- View statistics, if you logged as owner;
![stats](https://lh3.googleusercontent.com/IbY7ptp6r1YOaDb1Sa6A610gkdz6v5sDUPHrxJ2Cx4HxbInQVxKhqkj8AQJMKv0Xc9MBxpEYjAWqHJ9ZMJXhCx9zlE_6B9EhLb4CtUCcSeuxKjcLTwYplEaOl3i4IaWJyBNVpUPmg2t74srlt8-nQ6UGTpOe3o7Lj-ioF9V58U2YqxHY9f9OhErUBeLugqlYnJUEB--sdpxRBnu9gBOUNMEvz0x-00fynEFrNDP7b6dAGHdRPO1ewN7tf7DBEg7iemnM-hl89G7ztgaAhM7scoM5qeL3AC2jDhLi_hfb3bivzFE7qMck2QB8AF-SuaIY4wOrwpnL-YHxKlpe3tcJIXjfeFaFHj5Kjbtl6Lu4Sjm6AalnUoVBeAytaVtNij4zzpPo3sAjVJZxNx7Losj7lMHdabWdeauhpa91dmApndfUlWRBVVrkh6G94Sg3NPsv2AHffB4zq9TJhyLLaiXPJV4hPPpw04Q3252EKZziKGBkoLqnJr1U9g009shIfTt--1Mjp__Z6TiuHq3XMl5pXAzsRJAzd_mfmGrpw0FLJxxoGzJvtxmQyutEK_Y7pExV12nro-oS0C8GWmKBzB1zB8DNyce5zzdtHjQTc4k=w1919-h973-no)
<br>
Incomes and expenses in statistics of yacht, calculating in the DB function and it also has a few tgiggers, code below:

-----------------------------------------------------------------
Function to calculate incomes and expenses of yacht
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION maintance_month (bid INT)<br>
RETURNS<br>
TABLE (id integer,month_count integer, all_time_count integer, month_sum bigint, all_time_sum bigint,
	crew_count integer, total_salary bigint, repair_exp bigint)<br>
AS $$<br>
DECLARE <br>
month_count integer;
all_time_count integer;
month_sum bigint;
all_time_sum bigint;
crew_count integer;
total_salary bigint;
repair_exp bigint;<br>
BEGIN<br>
select count(boat_id) into month_count from boats_rentcontract
where boat_id=bid AND date_trunc('month', date_end) = date_trunc('month',now());<br>
select count(boat_id) into all_time_count from 
boats_rentcontract where boat_id=bid;<br>
select sum(total_price) into month_sum from boats_rentcontract 
where boat_id=bid AND date_trunc('month', date_end) = date_trunc('month',now());<br>
select sum(total_price) into all_time_sum from
boats_rentcontract where boat_id=bid;<br>
select count(crew_id) into crew_count from boats_boatcrew where 
boat_id=bid;<br>
select sum((extract(days from (date_trunc('day',now()) â€“ 
date_trunc('day', date_take_post)))/30)*salary) into total_salary from boats_boatcrew where boat_id=bid;<br>
select sum(repair_price) into repair_exp from 
boats_repaircontract where boat_id=bid;<br>
return Query<br>
select 1 as id, month_count, all_time_count, month_sum, all_time_sum, crew_count, total_salary, repair_exp;<br>
END;<br>
$$ LANGUAGE plpgsql;

-----------------------------------------------------------------
Trigger function to perform the INSERT operation to a table "boats_boat" that checks the dates of a new contract with existing rental contracts and repairs, and whether there is a yacht Captain
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION check_overlaps_F() RETURNS TRIGGER<br>
AS $$<br>
DECLARE<br>
r_beg boats_rentcontract.date_begin%TYPE;
r_end boats_rentcontract.date_end%TYPE;
b_beg boats_repaircontract.date_begin%TYPE;
b_end boats_repaircontract.date_end%TYPE;
cap boats_boatcrew.post%TYPE;
overlap BOOLEAN;<br>
BEGIN<br>
SELECT date_begin into r_beg FROM boats_rentcontract where boats_rentcontract.boat_id = New.boat_id;<br>
SELECT date_end into r_end FROM boats_rentcontract where boats_rentcontract.boat_id = New.boat_id;<br>
SELECT date_begin into b_beg FROM boats_repaircontract where boats_repaircontract.boat_id = New.boat_id;<br>
SELECT date_end into b_end FROM boats_repaircontract where boats_repaircontract.boat_id = New.boat_id;<br>
SELECT post into cap FROM boats_boatcrew where boats_boatcrew.boat_id = New.boat_id and boats_boatcrew.post='Captain';<br>
IF cap IS NULL THEN<br>
	RAISE EXCEPTION 'Boat not available, there is no Captain';<br>
end if;<br>
overlap := False;<br>
FOR r_beg, r_end in SELECT date_begin, date_end FROM boats_rentcontract where boats_rentcontract.boat_id = New.boat_id<br>
	LOOP IF (NEW.date_begin = r_end OR NEW.date_end = r_beg) THEN overlap := False;<br>
	ELSIF ((NEW.date_begin >=  r_beg AND NEW.date_begin <= r_end) OR (NEW.date_end >=  r_beg AND  NEW.date_end <= r_end)) THEN overlap := True;<br>
	ELSIF (NEW.date_begin <= r_beg AND NEW.date_begin >= r_end) THEN overlap := True;<br>
	END IF;<br>
END LOOP;<br>
IF overlap = True Then<br>
	RAISE EXCEPTION 'Overlap';<br>
END IF;<br>
FOR b_beg, b_end in SELECT date_begin, date_end FROM boats_repaircontract where boats_repaircontract.boat_id = New.boat_id<br>
	LOOP IF (NEW.date_begin = b_end OR NEW.date_end  = b_beg) THEN overlap := False;<br>
	ELSIF ((NEW.date_begin >=  b_beg AND NEW.date_begin <= b_end) OR (NEW.date_end >= b_beg AND  NEW.date_end <= b_end)) THEN overlap := True;<br>
	ELSIF (NEW.date_begin <= b_beg AND NEW.date_end >= b_end) THEN overlap := True;<br>
	END IF;<br>
END LOOP;<br>
IF overlap = True Then<br>
	RAISE EXCEPTION 'Overlap';<br>
ELSE RETURN NEW;<br>
END IF;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER check_overlaps<br>
BEFORE INSERT ON boats_rentcontract<br>
FOR EACH ROW EXECUTE PROCEDURE check_overlaps_F();

-----------------------------------------------------------------
Trigger function for the INSERT operation to a table "boats_boatcrew" that verifies whether the selected crew member has been recruited and whether the captain is on the yacht
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION crewrecruit_F() RETURNS TRIGGER<br>
AS $$<br>
DECLARE<br>
recr boats_crew.recruited%TYPE;
cap boats_boatcrew.post%TYPE;<br>
BEGIN<br>
select recruited into recr from boats_crew where id = NEW.crew_id;<br>
select post into cap from boats_boatcrew where boat_id = NEW.boat_id AND post='Captain';<br>
IF (recr = TRUE ) THEN <br>
	RAISE EXCEPTION 'This man already recruited';<br>
ELSIF (cap is not null and NEW.post ='Captain') THEN<br>
	RAISE EXCEPTION 'This yacht already have captain';<br>
ELSE<br>
	UPDATE boats_crew SET recruited = TRUE WHERE id = NEW.crew_id;<br>
RETURN NEW;<br>
END IF;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER crewrecruit<br>
BEFORE INSERT ON boats_boatcrew<br>
FOR EACH ROW EXECUTE PROCEDURE crewrecruit_F();

-----------------------------------------------------------------
Trigger function for the UPDATE operation to the "boats_boatcrew" table that checks whether the selected crew member is recruited and whether the captain is on the yacht
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION crewcap_F() RETURNS TRIGGER<br>
AS $$<br>
DECLARE<br>
cap boats_boatcrew.post%TYPE;<br>
BEGIN<br>
select post into cap from boats_boatcrew where boat_id = NEW.boat_id AND post='Captain';<br>
IF (cap is not null and NEW.post ='Captain') THEN <br>
	RAISE EXCEPTION 'This yacht already have captain';<br>
ELSE RETURN NEW;<br>
END IF;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER crewcap<br>
BEFORE UPDATE ON boats_boatcrew<br>
FOR EACH ROW EXECUTE PROCEDURE crewcap_F();<br>

-----------------------------------------------------------------
Trigger function for the INSERT operation to the "boats_repaircontract" table, which checks the dates of a new repair contract with existing lease and repair contracts
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION check_overlaps_repair_F() RETURNS TRIGGER<br>
AS $$<br>
DECLARE<br>
r_beg boats_rentcontract.date_begin%TYPE;
r_end boats_rentcontract.date_end%TYPE;
b_beg boats_repaircontract.date_begin%TYPE;
b_end boats_repaircontract.date_end%TYPE;
overlap BOOLEAN;<br>
BEGIN<br>
overlap := False;<br>
FOR r_beg, r_end in SELECT date_begin, date_end FROM boats_rentcontract where boats_rentcontract.boat_id = New.boat_id
	LOOP IF (NEW.date_begin = r_end OR NEW.date_end = r_beg) THEN overlap := False;<br>
	ELSIF ((NEW.date_begin >=  r_beg AND NEW.date_begin <= r_end) OR (NEW.date_end >=  r_beg AND  NEW.date_end <= r_end)) THEN<br>
		overlap := True;<br>
	ELSIF (NEW.date_begin <= r_beg AND NEW.date_begin >= r_end) THEN overlap := True;<br>
	END IF;<br>
END LOOP;<br>
IF overlap = True Then<br>
	RAISE EXCEPTION 'Overlap';<br>
END IF;<br>
FOR b_beg, b_end in SELECT date_begin, date_end FROM boats_repaircontract where boats_repaircontract.boat_id = New.boat_id<br>
	LOOP IF (NEW.date_begin = b_end OR NEW.date_end  = b_beg) THEN overlap := False;<br>
	ELSIF ((NEW.date_begin >=  b_beg AND NEW.date_begin <= b_end) OR (NEW.date_end >= b_beg AND  NEW.date_end <= b_end)) THEN overlap := True;<br>
	ELSIF (NEW.date_begin <= b_beg AND NEW.date_end >= b_end) THEN overlap := True;<br>
	END IF;<br>
END LOOP;<br>
IF overlap = True Then<br>
	RAISE EXCEPTION 'Overlap';<br>
ELSE RETURN NEW;<br>
END IF;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER check_overlaps_repair<br>
BEFORE INSERT ON boats_repaircontract<br>
FOR EACH ROW EXECUTE PROCEDURE check_overlaps_repair_F();
